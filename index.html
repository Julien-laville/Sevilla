<style type="text/css">
    TABLE {
    border:1px solid black;
    padding:0;
    margin:0;
    border-collapse: collapse;transform: rotateX(60deg) rotateY(0deg)
rotateZ(-45deg);
}


  @keyframes blink {
    0% {
           background-color: rgba(255,0,0,1)
    }
    50% {
           background-color: rgba(255,0,0,0.5)
    }
    100% {
           background-color: rgba(255,0,0,1)
    }
}
@-webkit-keyframes blink {
    0% {
           background-color: rgba(255,0,0,1)
    }
    50% {
           background-color: rgba(255,0,0,0.5)
    }
    100% {
           background-color: rgba(255,0,0,1)
    }
}

 .blin {
    animation:blink normal 1.5s infinite ease-in-out;
}


TD {
    height:40px;
    width:40px;
    border:1px solid #223344;
    font-size : 12px;
    text-align: center
}

TD:hover {
    background:#ecedef;
}

#tools {
    position: absolute;
    top:0;
}
    .active {
        color : greenyellow
    }
    #triggers {
        position: absolute;
        right: 0;
        top:0;
        text-align: right;
    }
    
</style>


<div id="p"></div>
<div id="tools">

    <div onclick='setF("INSERT")'>in</div>
    <div  onclick='setF("END")'>out</div>
    <div  onclick='setF("TRAP")'>trap</div>
    <div  onclick='setF("IDDLE")'>play</div>
    
    <div  onclick='setF("VOID")'>void</div>
    <div  onclick='setF("RIVER")'>river</div>
    
    <p></p>
        <div id="trigger" onclick='setF("TRIGGER")'>trigger</div>
    <p></p>
    
    <div  onclick='save()'>save</div>
    <div  onclick='localStorage.clear()'>clean</div>
    <div id="loadlist"></div>

</div>

<div id="triggers">
    triggers
</div>

<script>
var table = "<table>"

flag = 'INSERT'
var start = false;
var end = false
var traps = []
var pathes = []
var tempPathes = []
var tempLast = null
var last = false
var dir = null
var go = null
var forbidden = false
var isFisrt = true
var pLength = -1;
var rivers = [];
var onlyCloneCanCrossRiver = true
var triggerables = []
var subFlag = "iddle"




for(var i = 0; i < 20; i ++){
    var line = []
    for(var j = 0; j < 30; j ++) {

        line.push(`<td onmouseover="play(this)"
onclick="caseclick(this)" id="td_${i}_${j}">${i} ${j}</td>`)

    }
    table += '<tr>'+line.join('\n')+'</tr>'

}
    
    
    function save(){
        var map = {
            start : start,
            end: end,
            traps:traps,
            rivers:rivers
        }
        var rawMap = JSON.stringify(map)
        localStorage.setItem("bob_"+new Date().getTime(),rawMap)
    }
    
    function loadM(k) {
        var rawMap = localStorage.getItem(k)
        var map = JSON.parse(rawMap)
        
        start = map.start
         document.getElementById(start).style.background = "red"
        end = map.end
         document.getElementById(end).style.background = "green"
        rivers = map.rivers
        rivers.forEach(function(river){
            document.getElementById(river).style.background = "#d8f3ff"
        })
        traps = map.traps
        traps.forEach(function(trap) {
            document.getElementById(trap).style.background = "yellow"
        })
    }

    function setF(f) {
        if(f === 'TRIGGER' && subFlag === "iddle") {
            document.getElementById("trigger").innerHTML = "<span class='active'>trigger</span>"
            subFlag = "trigger"
        } else if(f === 'TRIGGER' && subFlag === "trigger") {
            document.getElementById("trigger").innerHTML = "door"
            subFlag = "door"
        } else if(f === 'TRIGGER' && subFlag === "door") {
            document.getElementById("trigger").innerHTML = "link"
            subFlag = "links"
        } else if(f === 'TRIGGER' && subFlag === "links") {
            document.getElementById("trigger").innerHTML = "trigger"
            subFlag = "iddle"            
        } else if(f !== 'TRIGGER') {
            document.getElementById("trigger").innerHTML = "trigger"
            subFlag = "iddle"
        }
        flag = f
        ready()
    }

    var loadAll = function() {
        var levels = []
        for(var key in localStorage) {
            if(key.indexOf('bob_') !== -1) {
                levels.push('<div onclick=\'loadM(\"'+key+'"\)\'>load '+key+'</div>')
            }
        }
        loadlist.innerHTML = levels.join('')
    }()

function caseclick(i) {
    var cases = i.id.split('_')
    var x = cases[1]
    var y = cases[2]

    if(flag === 'INSERT') {
        if(start) {
            var old = document.getElementById(start);
            old.style.background = "#ffffff"
        }
        start = i.id 
        last = start+""
        i.style.background = "red"
    } else if(flag === 'END') {
        if(end) {
            var old = document.getElementById(end);
            old.style.background = "#ffffff"
        }
        end = i.id 
        i.style.background = "green"
    } else if(flag === 'TRIGGER') {
        if(subFlag == 'trigger') {
            var t = {
                pos : i.id,
                walls : [],
                links : [],
                isOpen : false
            }
            triggerables.push(t)
            document.getElementById("trigger").innerHTML = "door"
            subFlag = "door"
            
            i.style.background = "#ef6a9d"
            i.innerHTML = "T"

        } else if(subFlag == 'door') {
            var lastTr = triggerables[triggerables.length-1]
            lastTr.walls.push(i.id)
            
            i.style.background = "#ef6a9d"
            i.innerHTML = "D"
        } else if(subFlag == 'links') {
            var lastTr = triggerables[triggerables.length-1]
            lastTr.links.push(i.id)
            
            i.style.color = "#ef6a9d"
            i.innerHTML = "."
        }
        var tList = triggerables.map(function(t,i) {
            return "<p>" + i + " " + t.walls.length + "</p>"
        })
        
        document.getElementById("triggers").innerHTML = tList.join("")
       
    }  else if(flag === 'TRAP') {
        end = i.id 
        traps.push(i.id )
        i.style.background = "yellow"
        
    } else if(flag === 'VOID') {
        traps.push(i.id )
       i.style.border = "none"
       i.style.color = "#fff"
    } else if(flag === 'RIVER'){
        rivers.push(i.id )
        i.style.border = "none"
        i.style.background = "#d8f3ff"
        i.style.color = "#d8f3ff"
    } else if(flag === 'IDDLE') {
        playS(i)
    } else if(flag === 'PLAY') {
        playC(i)
    }
}


    function ready() {
        if(last) {
            var x0 = parseInt(last.split('_')[1])
            var y0 = parseInt(last.split('_')[2])
            if(document.getElementById('td_' + (x0+1) + '_' + y0))
            document.getElementById('td_' + (x0+1) + '_' +
y0).className = "blin"
            if(document.getElementById('td_' + (x0-1) + '_' + y0))
            document.getElementById('td_' + (x0-1) + '_' +
y0).className = "blin"
            if(document.getElementById('td_' + x0 + '_' + (y0+1)))
            document.getElementById('td_' + x0 + '_' +
(y0+1)).className = "blin"
            if(document.getElementById('td_' + x0 + '_' + (y0-1)))
            document.getElementById('td_' + x0 + '_' +
(y0-1)).className = "blin"
        }
    }

function playS(i) {
    var x = parseInt(i.id.split("_")[1])
    var y = parseInt(i.id.split("_")[2])


    var lastx = parseInt(last.split("_")[1])
    var lasty = parseInt(last.split("_")[2])

    if(lastx == x) dir = 'h'
    else dir = 'v'
    
    
    if(!isFisrt) {
        var tempPathes2 = []
        if(x < lastx) { //^
            for(var j = 0; j < pLength; j ++) {
                tempPathes2.push('td_' + (x-j) + '_' + y)
            }
        } else if(x > lastx) { //<
           for(var j = 0; j < pLength; j ++) {
                tempPathes2.push('td_' + (x+j) + '_' + y)
            }
        } else if(y < lasty) { //v
            for(var j = 0; j < pLength; j ++) {
                tempPathes2.push('td_' + x + '_' + (y-j))
            }
            console.log("<")
        } else if(y > lasty) { //^
             for(var j = 0; j < pLength; j ++) {
                tempPathes2.push('td_' + x + '_' + (y+j))
            }
        }
        
        
        var forbidden = checkPath(tempPathes2)
        if(forbidden)    return
        
        tempPathes = tempPathes2
        
        tempLast = tempPathes[tempPathes.length-1]
        playC(document.getElementById(tempPathes[tempPathes.length-1]))
        return
       
    }
    
   
    
       
        

    if((lastx == x+1 && lasty == y) ||
       (lastx == x-1 && lasty == y) ||
       (lastx == x && lasty == y+1) ||
       (lastx == x && lasty == y-1)) {
             go = i.id 
            flag = 'PLAY'
    } else {
        console.log("cant start")
    }

}


function play(i) {
    if(flag !== 'PLAY') return;

        tempPathes.forEach(function(tp) {
            document.getElementById(tp).style.background = "#fff"

        })
        var x = parseInt(i.id.split("_")[1])
        var y = parseInt(i.id.split("_")[2])

        var ox = parseInt(go.split("_")[1])
        var oy = parseInt(go.split("_")[2])
        var dx = x - ox
        var dy = y - oy




        var lg = Math.max(Math.abs(dx),Math.abs(dy)) + 1
        if(lg < 1) return
        
        if(isFisrt) 
            pLength = lg
        else 
            lg = pLength

        forbidden = false
        tempPathes = []
        

             
       
            for(var i = 0; i < lg; i ++) {
                var id = ""
                var id2 = ""
                var x1 = -1
                var x2 = -1
                var y1 = -1
                var y2 = -1
                if(dir == 'v') {
                    if(dx < 0 && dy < 0) {
                        x1 = ox - i - 1
                        y1 = oy
                        x2 = ox - lg
                        y2 = oy - i
                    } else if(dx < 0 && dy >= 0) {
                        x1 = ox - i
                        y1 = oy
                        x2 = ox - lg
                        y2 = oy + i
                    } else if(dx >= 0 && dy < 0) {
                        x1 = ox + i
                        y1 = oy
                        x2 = ox + lg
                        y2 = oy - i
                    } else {
                        x1 = ox + i
                        y1 = oy
                        x2 = ox + lg
                        y2 = oy + i
                    }
                } else {
                     if(dx < 0 && dy < 0) {
                        x1 = ox - i
                        y1 = oy - lg
                        x2 = ox
                        y2 =oy -i
                    } else if(dx < 0 && dy >= 0) {
                        x1 = ox - i
                        y1 = oy + lg
                        x2 = ox
                        y2 = oy + i
                    } else if(dx >= 0 && dy < 0) {
                        x1 = ox + i
                        y1 = oy - lg
                        x2 = ox
                        y2 = oy - i
                    } else {
                        x1 = ox + i
                        y1 = oy + lg
                        x2 = ox
                        y2 = oy + i
                    }
                }

                if(x1 == -1 || x2 == -1 || y1 == -1 || y2 == -1) {
                    forbidden = true
                }
                if(dir=="v") {
                    id = "td_"+ x1 +"_" + y1

                } else {
                    id = "td_"+ x2 +"_" + y2
                    x2 = x1
                    y2 = y1 
                }

              tempPathes.push(id)

            
            
        } 
     forbidden = checkPath(tempPathes)
        var color = 'grey'
        if(forbidden) {
            color = 'pink'
        } 
    


    if(!forbidden) {
        tempLast = tempPathes[tempPathes.length - 1]
        


        tempPathes.forEach(function(tp) {
            document.getElementById(tp).style.background=color
        })


        traps.forEach(function(t) {
            document.getElementById(t).style.background="yellow"
        })
        if(end)
            document.getElementById(end).style.background = "green"


    }

}
    
    function checkPath(paths) {
        var forbidden = false
        paths.forEach(function(p,i) {
            var x = p.split("_")[1]
            var y = p.split("_")[2]
            traps.forEach(function(t) {
                if(t === p) {
                    forbidden = true
                }
            })
            
            triggerables.forEach(function(t) {
                t.walls.forEach(function(w,i) {
                    if(t === p && !t.isOpen) {
                        forbidden = true
                    }
                })
            })
            
            
            rivers.forEach(function(river) {
                if(i != paths.length - 1) {
                    if(river === p && (isFisrt && onlyCloneCanCrossRiver)) {
                        forbidden = true
                    }    
                }
            })
            
            /* cross the last */
            if(last === p) {
                forbidden = true
            }


            if(x < 0 ||x > 19 || 
                y < 0 || y>29) {
                forbidden = true
            }

            try {
                document.getElementById(p).style.background
            } catch(e) {
                forbidden = true
            }
        })
        return forbidden
       
    }


var begin = false
function playC(i) {
    
    var x = parseInt(i.id.split("_")[1])
    var y = parseInt(i.id.split("_")[2])

    var lx = parseInt(last.split("_")[1])
    var ly = parseInt(last.split("_")[2])
    

    
    
    
    if(forbidden) return;
    isFisrt = !isFisrt

    var lastx = parseInt(last.split("_")[1])
    var lasty = parseInt(last.split("_")[2])
    if(document.getElementById('td_' + (lastx+1) + '_' + lasty))
    document.getElementById('td_' + (lastx+1) + '_' + lasty).className = ""
    if(document.getElementById('td_' + (lastx-1) + '_' + lasty))
    document.getElementById('td_' + (lastx-1) + '_' + lasty).className = ""
    if(document.getElementById('td_' + lastx + '_' + (lasty+1)))
    document.getElementById('td_' + lastx + '_' + (lasty+1)).className = ""
    if(document.getElementById('td_' + lastx + '_' + (lasty-1)))
    document.getElementById('td_' + lastx + '_' + (lasty-1)).className = ""


    last = tempLast+""

    if(last === end)
        alert("Win !")
        
    triggerables.forEach(function(t){
        if(last === t.pos) {
            t.isOpen = true
            document.getElementById(t.pos).style.background = "yellowgreen"
            t.walls.forEach(function(w) {
                document.getElementById(w).style.background = "yellowgreen"
            })
            t.links.forEach(function(w) {
                document.getElementById(w).style.color = "yellowgreen"
            })
        }           
    })
        
    tempPathes.forEach(function(tp) {
        document.getElementById(tp).style.background = "purple"
    })
    tempPathes = []
    flag = 'IDDLE'
    ready()
}





table += '</table>'
p.innerHTML = table



</script>